<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒœã‚¹è¨ä¼å­¦ç¿’ã‚¢ãƒ—ãƒª v0.3.9 å—é¨“å¯¾ç­–</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow-x:hidden
    }
    .container{
      max-width:800px;width:90%;background:rgba(255,255,255,.1);padding:30px;border-radius:20px;
      backdrop-filter:blur(10px);box-shadow:0 10px 30px rgba(0,0,0,.3);position:relative;overflow:hidden
    }
    h1{text-align:center;font-size:2.4em;margin-bottom:28px;text-shadow:2px 2px 4px rgba(0,0,0,.3);position:relative;z-index:2}
    .save-indicator{position:fixed;top:20px;right:20px;background:rgba(76,175,80,.9);padding:10px 15px;border-radius:25px;font-size:.9em;opacity:0;transition:.3s;z-index:9999}
    .save-indicator.show{opacity:1}

    .setup-screen{text-align:center;padding:20px;position:relative;z-index:2}
    .setup-screen h2{font-size:1.8em;margin-bottom:20px;color:#FFE082}
    .returning-user{background:rgba(76,175,80,.2);border:2px solid #4CAF50;padding:20px;border-radius:15px;margin-bottom:25px;display:none}
    .user-input{margin-bottom:25px}
    .user-input label{display:block;font-size:1.2em;margin-bottom:10px}
    .user-input input{padding:12px 15px;font-size:1.1em;border:none;border-radius:10px;width:250px;max-width:100%;text-align:center}
    .grade-selection{margin:28px 0}
    .grade-btn{display:inline-block;padding:18px 34px;margin:8px 12px;font-size:1.15em;border:none;border-radius:14px;cursor:pointer;transition:.3s;background:rgba(255,255,255,.9);color:#333;font-weight:bold}
    .grade-btn:hover{background:#fff;transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .grade-btn.selected{background:#4CAF50 !important;color:#fff !important;animation:selectedPulse 1s ease infinite}
    @keyframes selectedPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .start-setup-btn{padding:14px 28px;font-size:1.2em;border:none;border-radius:12px;background:#FF6B6B;color:#fff;cursor:pointer;font-weight:bold;transition:.3s;margin-top:14px}
    .start-setup-btn:hover:not(:disabled){background:#FF5252;transform:scale(1.05)}
    .start-setup-btn:disabled{background:#666 !important;cursor:not-allowed !important;transform:none !important}
    .continue-btn,.new-game-btn{padding:12px 22px;border:none;border-radius:8px;cursor:pointer;font-size:1em;margin:0 8px;transition:.3s}
    .continue-btn{background:#4CAF50;color:#fff}.new-game-btn{background:#FF6B6B;color:#fff}

    .game-screen{display:none}
    .user-info{text-align:center;background:rgba(255,255,255,.1);padding:15px;border-radius:12px;margin-bottom:18px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:14px;position:relative;z-index:2}
    .user-info h3{color:#FFE082;font-size:1.2em}
    .session-stats,.total-stats{display:flex;gap:12px;font-size:.9em}

    .boss-section{position:relative;text-align:center;margin-bottom:26px;padding:20px;background:rgba(255,255,255,.1);border-radius:15px;overflow:hidden}
    .boss-bg{position:absolute;inset:0;z-index:1;display:flex;justify-content:center;align-items:flex-end;pointer-events:none;opacity:.6}
    .boss-bg img{width:min(100%,820px);max-height:95%;object-fit:contain;transform:translateY(6%);filter:drop-shadow(0 12px 30px rgba(0,0,0,.45))}
    .boss-section::after{content:"";position:absolute;inset:0;z-index:0;background:radial-gradient(120% 120% at 50% 100%, rgba(0,0,0,.22) 0%, rgba(0,0,0,.55) 75%, rgba(0,0,0,.65) 100%);pointer-events:none}
    .boss-name{position:relative;z-index:2;font-size:1.9em;margin-bottom:12px}
    .boss-name.victory{background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:victoryGlow 2s infinite alternate}
    @keyframes victoryGlow{0%{filter:drop-shadow(0 0 5px #FFD700)}100%{filter:drop-shadow(0 0 20px #FFD700)}}
    .hp-container{margin:18px 0;position:relative;z-index:2}
    .hp-bar{width:100%;height:40px;background:#333;border-radius:20px;overflow:hidden;border:3px solid #fff;position:relative}
    .hp-fill{height:100%;background:linear-gradient(90deg,#ff4444,#ff8844,#ffaa44);width:100%;transition:width .8s ease-out;position:relative}
    .hp-fill.damage-effect{animation:damageShake .6s ease-in-out}
    @keyframes damageShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .hp-text{font-size:1.1em;font-weight:bold;margin-top:8px;text-shadow:1px 1px 2px rgba(0,0,0,.5);position:relative;z-index:2}

    .question-section{background:rgba(255,255,255,.2);padding:22px;border-radius:15px;margin-bottom:18px;min-height:190px;position:relative;z-index:2}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
    .question-text{font-size:1.25em;margin-bottom:16px;text-align:center;line-height:1.5}
    .difficulty-indicator{display:inline-block;padding:5px 12px;border-radius:20px;font-size:.9em;font-weight:bold}
    .difficulty-easy{background:#4CAF50;color:#fff}.difficulty-normal{background:#FF9800;color:#fff}.difficulty-hard{background:#f44336;color:#fff}
    .subject-tag{background:rgba(255,255,255,.2);padding:5px 12px;border-radius:20px;font-size:.8em}
    .options-container{display:grid;gap:10px}
    .option-btn{padding:14px 18px;font-size:1.05em;border:none;border-radius:12px;background:rgba(255,255,255,.92);color:#333;cursor:pointer;transition:.25s;text-align:left;font-weight:500}
    .option-btn:hover:not(:disabled){background:#fff;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .option-btn:disabled{cursor:not-allowed}
    .option-btn.correct{background:#4CAF50 !important;color:#fff;animation:correctPulse .5s ease}
    .option-btn.incorrect{background:#f44336 !important;color:#fff}
    @keyframes correctPulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

    .controls{text-align:center;margin:16px 0;position:relative;z-index:2}
    .control-btn{padding:14px 26px;font-size:1.15em;border:none;border-radius:12px;background:#4CAF50;color:#fff;cursor:pointer;margin:0 8px;transition:.25s;font-weight:bold}
    .control-btn:hover:not(:disabled){background:#45a049;transform:scale(1.05)}
    .control-btn:disabled{background:#666;cursor:not-allowed;transform:none}
    .back-btn{background:#FF6B6B}.back-btn:hover{background:#FF5252}

    .stats{background:rgba(0,0,0,.3);padding:18px;border-radius:12px;margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;text-align:center;position:relative;z-index:2}
    .stat-item{font-size:1.05em}.stat-value{font-size:1.35em;font-weight:bold;color:#4CAF50;display:block;margin-top:5px}
    .result-text{font-size:1.15em;font-weight:bold;margin:12px 0;text-align:center;min-height:28px;text-shadow:1px 1px 2px rgba(0,0,0,.5);position:relative;z-index:2}
    .victory{background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

    .levelup-notification{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#FFD700,#FFA500);color:#333;padding:26px 44px;border-radius:18px;font-size:1.6em;font-weight:bold;z-index:9999;opacity:0;animation:levelUpShow 3s ease-in-out;box-shadow:0 10px 30px rgba(255,215,0,.5)}
    @keyframes levelUpShow{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0}}

    /* ãƒ•ãƒ­ãƒ³ãƒˆæ¼”å‡ºã¯æœ€å‰é¢ã®å°‚ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã« */
    .fx-layer{position:fixed;inset:0;pointer-events:none;z-index:9998;overflow:hidden}

    /* æ–¬æ’ƒãƒ»ç«ã®ç²‰ãƒ»æºã‚Œ */
    .slash-effect{position:absolute;left:50%;top:50%;width:140%;height:6px;transform-origin:center;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.95) 45%,rgba(255,200,120,.95) 55%,rgba(255,80,40,0) 100%);box-shadow:0 0 18px rgba(255,180,80,.7),0 0 40px rgba(255,120,60,.5);border-radius:999px;z-index:3;pointer-events:none;animation:slashFly .35s ease-out forwards}
    @keyframes slashFly{0%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(.2);opacity:0}10%{opacity:1}60%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(1);opacity:1}100%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(1.3);opacity:0}}
    .spark{position:absolute;width:4px;height:4px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#ffcf7a 60%,#ff6a00 100%);box-shadow:0 0 8px rgba(255,120,40,.9);pointer-events:none;z-index:4;animation:sparkFly .6s ease-out forwards}
    @keyframes sparkFly{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(.6);opacity:0}}
    .shake{animation:shakeKey .38s linear}
    @keyframes shakeKey{0%{transform:translate(0,0)}20%{transform:translate(2px,-2px)}40%{transform:translate(-3px,2px)}60%{transform:translate(3px,1px)}80%{transform:translate(-2px,-3px)}100%{transform:translate(0,0)}}

    /* æ’ƒç ´ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ */
    .white-flash{position:absolute;inset:0;background:#fff;opacity:0;z-index:5;pointer-events:none;animation:whiteFlash .5s ease-out forwards}
    @keyframes whiteFlash{0%{opacity:0}10%{opacity:.9}100%{opacity:0}}
    .boss-bg img.defeated{animation:bossFall 1.2s ease forwards}
    @keyframes bossFall{0%{transform:translateY(6%) scale(1) rotate(0deg);opacity:1}35%{transform:translateY(2%) scale(.98) rotate(-4deg)}70%{transform:translateY(12%) scale(.9) rotate(6deg);filter:grayscale(.2) brightness(1.1)}100%{transform:translateY(40%) scale(.6) rotate(-12deg);opacity:0;filter:grayscale(.6) brightness(.9)}}
    .burst{position:absolute;left:50%;top:50%;width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,#fff,#ffd27a,#ff7a00);transform:translate(-50%,-50%);z-index:6;animation:burstOut .7s ease-out forwards;pointer-events:none}
    @keyframes burstOut{0%{transform:translate(-50%,-50%) scale(.2);opacity:.9}100%{transform:translate(-50%,-50%) scale(12);opacity:0}}
    .victory-banner{position:absolute;left:50%;top:46%;transform:translate(-50%,-50%) scale(.8);z-index:6;font-size:2.4em;font-weight:900;letter-spacing:.08em;background:linear-gradient(45deg,#fff,#ffe6a3);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 18px rgba(255,220,120,.65);opacity:0;animation:bannerPop 1.1s ease-out .15s forwards}
    @keyframes bannerPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}

    /* ãƒ¢ãƒã‚¤ãƒ«è»½é‡åŒ– */
    @media (max-width:480px){
      .container{width:96%;padding:18px}
      .hp-bar{height:34px}
      .boss-bg img.defeated{animation:bossFallSafe .8s ease forwards}
      @keyframes bossFallSafe{
        0%{transform:translateY(6%) scale(1);opacity:1}
        100%{transform:translateY(30%) scale(.8);opacity:0}
      }
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important;transition:none !important}
    }

    /* ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ï¼šJSãŒå¤±æ•—ã—ã¦ã‚‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯è¡¨ç¤º */
    .boot-note{position:fixed;left:50%;top:12px;transform:translateX(-50%);padding:8px 12px;border-radius:10px;background:rgba(0,0,0,.35);backdrop-filter:blur(6px);font-size:12px}
    .boot-note.error{background:#b00020}
  </style>
</head>
<body>
  <div class="container" id="root" aria-live="polite">
    <h1>ğŸ° ãƒœã‚¹è¨ä¼å­¦ç¿’ã‚¢ãƒ—ãƒª v0.3.9 å—é¨“å¯¾ç­–</h1>
    <div class="save-indicator" id="save-indicator">é€²æ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ</div>

    <div class="setup-screen" id="setup-screen">
      <h2>ğŸ¯ å†’é™ºã®æº–å‚™ã‚’ã—ã‚ˆã†ï¼</h2>
      <div class="returning-user" id="returning-user">
        <h3>ğŸ‰ ãŠã‹ãˆã‚Šãªã•ã„ï¼</h3>
        <div id="user-progress"></div>
        <div style="margin: 15px 0;">
          <button class="continue-btn" id="continue-btn">ç¶šãã‹ã‚‰å§‹ã‚ã‚‹</button>
          <button class="new-game-btn" id="new-game-btn">æœ€åˆã‹ã‚‰å§‹ã‚ã‚‹</button>
        </div>
      </div>

      <div id="new-user-setup">
        <div class="user-input">
          <label for="user-name">ğŸ‘¤ ãŠåå‰ã‚’æ•™ãˆã¦ã­</label>
          <input type="text" id="user-name" placeholder="ä¾‹: ãªã¾ãˆã‚’å…¥ã‚Œã¦" maxlength="10"/>
        </div>
        <div class="user-input">
          <label>ğŸ“š å­¦å¹´ã‚’é¸ã‚“ã§ã­</label>
          <div class="grade-selection">
            <button class="grade-btn" data-grade="elementary">ğŸŒ¸ å°å­¦ï¼ˆä¸­å­¦å—é¨“ï¼‰</button>
            <button class="grade-btn" data-grade="junior">ğŸŒŸ ä¸­å­¦ï¼ˆé«˜æ ¡å—é¨“ï¼‰</button>
          </div>
        </div>
        <button class="start-setup-btn" id="start-game-btn" disabled>ğŸš€ å†’é™ºã‚’å§‹ã‚ã‚‹ï¼</button>
      </div>
    </div>

    <div class="game-screen" id="game-screen">
      <div class="user-info">
        <div class="session-stats">
          <div>ä»Šæ—¥: <span id="today-questions">0</span>å•</div>
          <div>æ­£ç­”: <span id="today-correct">0</span></div>
        </div>
        <h3 id="user-greeting">ãŒã‚“ã°ã£ã¦ï¼</h3>
        <div class="total-stats">
          <div>ç´¯è¨ˆ: <span id="total-questions">0</span>å•</div>
          <div>Lv: <span id="user-level">1</span></div>
        </div>
      </div>

      <div class="boss-section">
        <div class="boss-name" id="boss-name">ğŸ‰ ãƒ•ãƒ¬ã‚¤ãƒ ãƒ‰ãƒ©ã‚´ãƒ³</div>
        <div class="hp-container">
          <div class="hp-bar"><div class="hp-fill" id="hp-fill"></div></div>
          <div class="hp-text">HP: <span id="hp-display">100/100</span></div>
        </div>
        <div class="boss-bg" id="boss-bg"><img alt="boss" /></div>
      </div>

      <div class="question-section">
        <div class="question-header">
          <div class="subject-tag" id="subject-tag">å—é¨“å¯¾ç­–</div>
          <div class="difficulty-indicator difficulty-normal" id="difficulty-indicator">â˜… æ™®é€š</div>
        </div>
        <div class="question-text" id="question-text">ã€Œã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒœã‚¹è¨ä¼ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>
        <div class="options-container" id="options-container"></div>
        <div class="result-text" id="result-text"></div>
      </div>

      <div class="controls">
        <button class="control-btn" id="start-btn">ğŸ® ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹</button>
        <button class="control-btn" id="next-btn" style="display:none">â¡ï¸ æ¬¡ã®å•é¡Œ</button>
        <button class="control-btn" id="reset-btn" style="display:none">ğŸ”„ æœ€åˆã‹ã‚‰</button>
        <button class="control-btn back-btn" id="back-btn">â¬…ï¸ è¨­å®šã«æˆ»ã‚‹</button>
      </div>

      <div class="stats">
        <div class="stat-item">æ­£ç­”æ•°<span class="stat-value" id="correct-count">0</span></div>
        <div class="stat-item">ç·ãƒ€ãƒ¡ãƒ¼ã‚¸<span class="stat-value" id="total-damage">0</span></div>
        <div class="stat-item">é€£ç¶šæ­£è§£<span class="stat-value" id="streak-count">0</span></div>
        <div class="stat-item">å•é¡Œæ•°<span class="stat-value" id="question-count">0</span></div>
      </div>
    </div>
  </div>

  <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæœ€å‰é¢ -->
  <div id="fx-layer" class="fx-layer" aria-hidden="true"></div>

  <!-- ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ãƒ¡ãƒ¢ -->
  <div id="boot-note" class="boot-note">åˆæœŸåŒ–ä¸­â€¦ï¼ˆ1ç§’ä»¥ä¸Šã‹ã‹ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ï¼‰</div>

  <script>
  // ======= ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ï¼šç”»é¢ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ =======
  (function(){
    window.addEventListener('error', e=>{
      const n=document.getElementById('boot-note');
      if(n){ n.textContent='ã‚¨ãƒ©ãƒ¼: '+(e.message||'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'); n.classList.add('error'); }
      console.error(e.error||e.message);
    });
    window.addEventListener('unhandledrejection', e=>{
      const n=document.getElementById('boot-note');
      if(n){ n.textContent='Promiseã‚¨ãƒ©ãƒ¼: '+(e.reason?.message||e.reason||'ä¸æ˜'); n.classList.add('error'); }
      console.error(e.reason);
    });
  })();
  </script>

  <script>
  // ======= ã‚¢ãƒ—ãƒªæœ¬ä½“ =======
  (function(){
    'use strict';
    try{
      /* ---------- ç’°å¢ƒåˆ¤å®š ---------- */
      const IS_MOBILE = matchMedia('(max-width:480px), (pointer:coarse)').matches;

      /* ---------- ãƒœã‚¹è¨­å®š ---------- */
      const BOSS_LIST = [
        { key:'dragon-main', name:'ãƒ‰ãƒ©ã‚´ãƒ³' },
        { key:'funtom',      name:'ãƒ•ã‚¡ãƒ³ãƒˆãƒ ' },
        { key:'kyojin',      name:'å·¨äºº' },
        { key:'medusa',      name:'ãƒ¡ãƒ‡ãƒ¥ãƒ¼ã‚µ' },
        { key:'sukal',       name:'ã‚¹ã‚«ãƒ«' }
      ];
      const HP_CURVE = [100,130,170,220,280];

      const folders=['image','images','./image','./images','/image','/images'];
      const exts=['jpeg','jpg','png','webp'];
      const buildCandidates=(key)=>{const a=[];folders.forEach(f=>exts.forEach(ext=>a.push(`${f}/${key}.${ext}`)));return a};
      const shuffle=a=>{a=a.slice();for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a};

      /* ---------- å•é¡Œï¼ˆçŸ­ç¸®ï¼‰ ---------- */
      const QUESTIONS={
        elementary:[
          {id:'e1',subject:'ç®—æ•°',difficulty:2,question:'Aã¨Bã®æ¯”ãŒ3:5ã€A+B=64ã€‚Aã¯ï¼Ÿ',options:['24','32','40','48'],correct:0,explanation:'8ç­‰åˆ†â†’1å˜ä½=8ã€A=8Ã—3'},
          {id:'e2',subject:'ç®—æ•°',difficulty:2,question:'é£Ÿå¡©æ°´15%ã‚’200gã€‚é£Ÿå¡©ã¯ï¼Ÿ',options:['20g','25g','30g','35g'],correct:2,explanation:'200Ã—0.15=30g'},
        ],
        junior:[
          {id:'j1',subject:'æ•°å­¦',difficulty:2,question:'2x-3=5x+9 ã®è§£ã¯ï¼Ÿ',options:['x=-4','x=4','x=-2','x=2'],correct:0,explanation:'-12=3x'}
        ]
      };

      /* ---------- çŠ¶æ…‹ ---------- */
      let app={
        user:{name:'',grade:'',level:1,exp:0},
        game:{bossHp:0,maxHp:0,correctCount:0,totalDamage:0,streakCount:0,questionCount:0,currentQuestion:null,usedQuestions:[],gameActive:false,_qStart:0,finalePlayed:false},
        stats:{daily:{date:new Date().toDateString(),questions:0,correct:0,damage:0},total:{questions:0,correct:0,damage:0,bossesDefeated:0}},
        history:{elementary:[],junior:[]},
        progress:{bossIndex:0,bossOrder:[]}
      };

      /* ---------- DOM ---------- */
      const dom={};
      function $(id){return document.getElementById(id)}
      function initializeDOM(){
        [
          'save-indicator','setup-screen','game-screen','returning-user','user-progress','continue-btn','new-game-btn',
          'new-user-setup','user-name','start-game-btn','user-greeting','today-questions','today-correct','total-questions',
          'user-level','boss-name','hp-fill','hp-display','subject-tag','difficulty-indicator','question-text','options-container',
          'result-text','start-btn','next-btn','reset-btn','back-btn','correct-count','total-damage','streak-count','question-count',
          'boss-bg'
        ].forEach(id=>dom[id.replace(/-/g,'')]= $(id));
        dom.gradeBtns=document.querySelectorAll('.grade-btn');
        dom.bossimg=dom.bossbg.querySelector('img');
        dom.fx=$('fx-layer');
      }

      /* ---------- Storage ---------- */
      let saveTimer=0;
      function debounceSave(){clearTimeout(saveTimer);saveTimer=setTimeout(saveData,150)}
      function saveData(){try{localStorage.setItem('bossAppExam',JSON.stringify(app));showSaveIndicator()}catch(e){console.error(e)}}
      function loadData(){
        try{
          const raw=localStorage.getItem('bossAppExam'); if(!raw) return null;
          const saved=JSON.parse(raw)||{}; ensureSchema(saved); ensureDaily(saved); return saved;
        }catch(e){console.warn('load failed',e); localStorage.removeItem('bossAppExam'); return null}
      }
      function ensureSchema(s){
        if(!s.history) s.history={elementary:[],junior:[]};
        if(!s.game) s.game=app.game;
        if(s.game.finalePlayed==null) s.game.finalePlayed=false;
        if(!s.progress) s.progress={bossIndex:0,bossOrder:[]};
      }
      function ensureDaily(s){
        const today=new Date().toDateString();
        if(!s.stats) s.stats=app.stats;
        if(!s.stats.daily || s.stats.daily.date!==today) s.stats.daily={date:today,questions:0,correct:0,damage:0};
      }
      function showSaveIndicator(){const n=dom.saveindicator; if(!n) return; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'),900)}

      /* ---------- ãƒœã‚¹ ---------- */
      const ensureBossOrder=()=>{const n=BOSS_LIST.length; if(!Array.isArray(app.progress.bossOrder)||app.progress.bossOrder.length!==n){app.progress.bossOrder=shuffle([...Array(n).keys()])}};
      function currentBoss(){
        ensureBossOrder();
        const stageIdx= app.progress.bossIndex % BOSS_LIST.length;
        const bossIdx = app.progress.bossOrder[stageIdx];
        const meta=BOSS_LIST[bossIdx];
        const hp= HP_CURVE[stageIdx] ?? Math.round(100*Math.pow(1.3,stageIdx));
        const files=[...new Set([...buildCandidates(meta.key),...buildCandidates('dragon-main')])];
        return {stageIdx,bossIdx,name:meta.name,files,hp};
      }
      function applyBossToUI(){
        const b=currentBoss();
        dom.bossname.textContent='ğŸ‰ '+b.name;
        const newImg=document.createElement('img'); newImg.alt='boss';
        let i=0;
        const tryNext=()=>{
          if(i>=b.files.length){ console.warn('ç”»åƒå€™è£œãªã—',b.files); return; }
          const p=b.files[i++]; newImg.onerror=tryNext; newImg.onload=()=>console.log('Loaded',p);
          newImg.src=encodeURI(p)+(p.includes('?')?'&':'?')+'v=3';
        };
        tryNext();
        if(dom.bossimg && dom.bossimg.parentNode) dom.bossimg.parentNode.replaceChild(newImg,dom.bossimg);
        else dom.bossbg.appendChild(newImg);
        dom.bossimg=newImg;
      }
      function setBossAndResetSession(){
        const b=currentBoss();
        app.game={bossHp:b.hp,maxHp:b.hp,correctCount:0,totalDamage:0,streakCount:0,questionCount:0,currentQuestion:null,usedQuestions:[],gameActive:false,_qStart:0,finalePlayed:false};
        cleanupEffects(); applyBossToUI(); renderHP(); renderStats(); debounceSave();
      }
      function advanceBoss(){
        app.progress.bossIndex++;
        if(app.progress.bossIndex%BOSS_LIST.length===0){ app.progress.bossOrder=shuffle([...Array(BOSS_LIST.length).keys()]); }
        setBossAndResetSession();
        dom.resulttext.textContent='æ–°ã—ã„ãƒœã‚¹ãŒç¾ã‚ŒãŸï¼';
        dom.startbtn.style.display='inline-block';
        dom.nextbtn.style.display='none';
        dom.resetbtn.style.display='none';
      }

      /* ---------- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ­ãƒƒã‚¯ ---------- */
      let layoutLocked=false;
      function lockLayout(){ if(layoutLocked) return; const root=$('root'); root.style.height=root.offsetHeight+'px'; document.body.style.overflow='hidden'; layoutLocked=true; }
      function unlockLayout(){ if(!layoutLocked) return; const root=$('root'); root.style.height=''; document.body.style.overflow=''; layoutLocked=false; }

      /* ---------- ç”»é¢åˆ¶å¾¡ ---------- */
      function enterSetup(){
        dom.setupscreen.style.display='block'; dom.gamescreen.style.display='none';
        const saved=loadData();
        if(saved){
          app=saved; ensureSchema(app);
          dom.returninguser.style.display='block';
          dom.userprogress.textContent=`å‰å›ï¼šç´¯è¨ˆ${app.stats.total.questions}å• / æ­£ç­”${app.stats.total.correct} / è¨ä¼${app.stats.total.bossesDefeated}`;
          dom.continuebtn.onclick=()=>enterGame();
          dom.newgamebtn.onclick=()=>{
            app.progress.bossIndex=0; app.progress.bossOrder=shuffle([...Array(BOSS_LIST.length).keys()]);
            setBossAndResetSession(); saveData(); enterGame();
          };
        }else{
          dom.returninguser.style.display='none';
        }
      }
      function enterGame(){
        dom.setupscreen.style.display='none'; dom.gamescreen.style.display='block';
        dom.usergreeting.textContent=`${app.user.name}ã€ãŒã‚“ã°ã£ã¦ï¼`;
        if(app.game.maxHp<=0){ setBossAndResetSession(); } else { applyBossToUI(); renderHP(); renderStats(); }
        dom.resulttext.textContent='ã€Œã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒœã‚¹è¨ä¼ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼';
        dom.optionscontainer.innerHTML='';
        dom.nextbtn.style.display='none';
        dom.resetbtn.style.display=app.game.bossHp===0?'inline-block':'none';
        dom.resetbtn.textContent=app.game.bossHp===0?'âš”ï¸ æ¬¡ã®ãƒœã‚¹ã¸':'ğŸ”„ æœ€åˆã‹ã‚‰';
        dom.startbtn.style.display='inline-block';
      }
      function renderHP(){
        const pct=Math.max(0,Math.min(100,(app.game.bossHp/app.game.maxHp)*100));
        dom.hpfill.style.width=pct+'%';
        dom.hpdisplay.textContent=`${app.game.bossHp}/${app.game.maxHp}`;
        if(app.game.bossHp===0){
          dom.bossname.classList.add('victory');
          dom.resulttext.innerHTML='ğŸ‰ <span class="victory">è¨ä¼æˆåŠŸï¼</span> ğŸ‰';
          dom.resetbtn.style.display='inline-block';
          dom.resetbtn.textContent='âš”ï¸ æ¬¡ã®ãƒœã‚¹ã¸';
          if(!app.game.finalePlayed){ playFinale(); app.game.finalePlayed=true; debounceSave(); }
        }else{
          dom.bossname.classList.remove('victory');
          dom.resetbtn.textContent='ğŸ”„ æœ€åˆã‹ã‚‰';
        }
      }
      function renderStats(){
        dom.todayquestions.textContent=app.stats.daily.questions;
        dom.todaycorrect.textContent=app.stats.daily.correct;
        dom.totalquestions.textContent=app.stats.total.questions;
        dom.userlevel.textContent=app.user.level;
        dom.correctcount.textContent=app.game.correctCount;
        dom.totaldamage.textContent=app.game.totalDamage;
        dom.streakcount.textContent=app.game.streakCount;
        dom.questioncount.textContent=app.game.questionCount;
      }

      /* ---------- å‡ºé¡Œ ---------- */
      function selectGrade(g){ app.user.grade=g; dom.gradeBtns.forEach(b=>b.classList.toggle('selected',b.dataset.grade===g)); updateStartButton(); }
      function updateStartButton(){ const ok=dom.username.value.trim().length>0 && !!app.user.grade; dom.startgamebtn.disabled=!ok; }
      function resetSession(){ const b=currentBoss(); app.game={bossHp:b.hp,maxHp:b.hp,correctCount:0,totalDamage:0,streakCount:0,questionCount:0,currentQuestion:null,usedQuestions:[],gameActive:false,_qStart:0,finalePlayed:false}; cleanupEffects(); renderHP(); renderStats(); debounceSave(); }
      function startQuest(){ if(app.game.bossHp===0||!app.user.grade) return; app.game.gameActive=true; pickQuestion(); renderQuestion(); }
      function pickQuestion(){
        const grade=app.user.grade; const pool=(QUESTIONS[grade]||[]).slice();
        const seen=new Set(app.history[grade]||[]); const used=new Set(app.game.usedQuestions||[]);
        let remain=pool.filter(q=>!seen.has(q.id)&&!used.has(q.id));
        if(remain.length===0){
          app.history[grade]=(app.history[grade]||[]).slice(-50);
          remain=pool.filter(q=>!new Set(app.history[grade]).has(q.id)&&!used.has(q.id));
          if(remain.length===0){ app.game.usedQuestions=[]; remain=pool; }
        }
        const q=remain[Math.floor(Math.random()*remain.length)];
        app.game.currentQuestion=q; app.game._qStart=Date.now(); app.game.usedQuestions.push(q.id);
        const h=app.history[grade]; h.push(q.id); if(h.length>200) h.splice(0,h.length-200);
        debounceSave();
      }
      function renderQuestion(){
        const q=app.game.currentQuestion; if(!q) return;
        dom.subjecttag.textContent=q.subject||'å—é¨“å¯¾ç­–';
        const diffClass=q.difficulty<=1?'difficulty-easy':(q.difficulty===2?'difficulty-normal':'difficulty-hard');
        const diffText=q.difficulty<=1?'â˜… ã‹ã‚“ãŸã‚“':(q.difficulty===2?'â˜… æ™®é€š':'â˜… é›£ã—ã„');
        dom.difficultyindicator.className='difficulty-indicator '+diffClass;
        dom.difficultyindicator.textContent=diffText;
        dom.questiontext.textContent=q.question;
        dom.resulttext.textContent='';
        dom.optionscontainer.innerHTML='';
        q.options.forEach((opt,idx)=>{ const b=document.createElement('button'); b.className='option-btn'; b.textContent=opt; b.onclick=()=>checkAnswer(idx,b); dom.optionscontainer.appendChild(b); });
        dom.startbtn.style.display='none';
        dom.nextbtn.style.display='none';
      }
      function computeDamage(q,elapsed){ const base=10; const diff=({1:0.9,2:1.0,3:1.12})[q.difficulty]??1; const combo=Math.min(1.6,1+0.06*Math.max(0,app.game.streakCount-1)); const timeBonus=Math.max(0,Math.min(0.22,(30-elapsed)/30*0.22)); return Math.round(base*diff*combo*(1+timeBonus)); }
      function checkAnswer(idx,btn){
        const q=app.game.currentQuestion; if(!q) return;
        const buttons=[...dom.optionscontainer.querySelectorAll('.option-btn')];
        const elapsed=(Date.now()-app.game._qStart)/1000;
        if(idx===q.correct){
          btn.classList.add('correct'); buttons.forEach(b=>b.disabled=true);
          app.game.streakCount++; app.game.correctCount++; app.stats.daily.correct++; app.stats.total.correct++;
          const dmg=computeDamage(q,elapsed);
          app.game.totalDamage+=dmg; app.stats.daily.damage+=dmg; app.stats.total.damage+=dmg;
          const before=app.game.bossHp; app.game.bossHp=Math.max(0,app.game.bossHp-dmg);
          playSlashEffect(); spawnSparks(); screenShake();
          dom.hpfill.classList.add('damage-effect'); setTimeout(()=>dom.hpfill.classList.remove('damage-effect'),600);
          app.user.exp+=Math.max(1,Math.floor(dmg/5)); if(app.user.exp>=20){ app.user.level++; app.user.exp=0; notifyLevelUp(); }
          dom.resulttext.textContent=`æ­£è§£ï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
          app.game.questionCount++; app.stats.daily.questions++; app.stats.total.questions++;
          renderHP(); renderStats(); debounceSave();
          if(before>0 && app.game.bossHp===0){ app.stats.total.bossesDefeated++; dom.nextbtn.style.display='none'; dom.resetbtn.style.display='inline-block'; dom.resetbtn.textContent='âš”ï¸ æ¬¡ã®ãƒœã‚¹ã¸'; debounceSave(); return; }
          dom.nextbtn.style.display='inline-block';
        }else{
          btn.classList.add('incorrect'); buttons.forEach(b=>b.disabled=false);
          app.game.streakCount=0; dom.resulttext.textContent=`ã‚‚ã†ä¸€åº¦ï¼ ãƒ’ãƒ³ãƒˆ: ${q.explanation}`; renderStats();
        }
      }

      /* ---------- æ¼”å‡º ---------- */
      function playSlashEffect(){ const d=document.createElement('div'); d.className='slash-effect'; dom.fx.appendChild(d); setTimeout(()=>d.remove(),380); }
      function spawnSparks(){
        const host=document.querySelector('.boss-section'); const r=host.getBoundingClientRect();
        const cx=r.left+r.width/2, cy=r.top+r.height/2; const N=IS_MOBILE?14:26;
        for(let i=0;i<N;i++){ const sp=document.createElement('div'); sp.className='spark'; sp.style.left=(cx-2)+'px'; sp.style.top=(cy-2)+'px';
          const ang=(Math.PI*2)*(i/N)+(Math.random()*0.6-0.3); const dist=(IS_MOBILE?70:90)+Math.random()*(IS_MOBILE?90:130);
          sp.style.setProperty('--dx', Math.cos(ang)*dist+'px'); sp.style.setProperty('--dy', Math.sin(ang)*dist+'px');
          dom.fx.appendChild(sp); setTimeout(()=>sp.remove(),650);
        }
      }
      function screenShake(){ if(IS_MOBILE) return; const root=$('root'); root.classList.add('shake'); setTimeout(()=>root.classList.remove('shake'),380) }
      function notifyLevelUp(){ const n=document.createElement('div'); n.className='levelup-notification'; n.textContent=`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${app.user.level}`; document.body.appendChild(n); setTimeout(()=>n.remove(),2200); renderStats(); }
      function playFinale(){
        lockLayout();
        const host=document.querySelector('.boss-section'); const hpBar=document.querySelector('.hp-bar'); const img=dom.bossimg;
        if(img){ img.classList.remove('defeated'); void img.offsetWidth; img.classList.add('defeated'); }
        const flash=document.createElement('div'); flash.className='white-flash'; dom.fx.appendChild(flash); setTimeout(()=>flash.remove(),500);
        const burst=document.createElement('div'); burst.className='burst'; dom.fx.appendChild(burst); setTimeout(()=>burst.remove(),700);
        hpBar.classList.add('hp-explode'); setTimeout(()=>hpBar.classList.remove('hp-explode'),520);
        launchConfetti(IS_MOBILE?40:100);
        fireworkAt(host,.28,.45); fireworkAt(host,.72,.38); if(!IS_MOBILE) fireworkAt(host,.5,.28);
        const banner=document.createElement('div'); banner.className='victory-banner'; banner.textContent='è¨ ä¼ æˆ åŠŸ !!'; dom.fx.appendChild(banner); setTimeout(()=>banner.remove(),2200);
        setTimeout(unlockLayout,2400);
      }
      function launchConfetti(n){
        const colors=['#ffd166','#06d6a0','#ef476f','#118ab2','#ffe66d','#f78c6b','#a8dadc','#e63946'];
        for(let i=0;i<n;i++){ const c=document.createElement('div'); c.className='confetti'; const sz=8+Math.random()*(IS_MOBILE?6:10);
          c.style.width=sz+'px'; c.style.height=(sz*1.4)+'px'; c.style.left=(Math.random()*100)+'%'; c.style.background=colors[(Math.random()*colors.length)|0];
          c.style.setProperty('--t',(IS_MOBILE?1.4:1.8)+Math.random()*(IS_MOBILE?1.0:1.6)+'s'); c.style.setProperty('--r',(Math.random()*360-180)+'deg'); c.style.opacity=0.95;
          dom.fx.appendChild(c); setTimeout(()=>c.remove(),2600);
        }
      }
      function fireworkAt(host,px,py){
        const r=host.getBoundingClientRect(); const x=r.left+r.width*px, y=r.top+r.height*py; const N=IS_MOBILE?18:30;
        for(let i=0;i<N;i++){ const sp=document.createElement('div'); sp.className='spark'; sp.style.left=x+'px'; sp.style.top=y+'px';
          const ang=(Math.PI*2)*(i/N)+(Math.random()*0.5-0.25); const dist=(IS_MOBILE?80:110)+Math.random()*(IS_MOBILE?100:150);
          sp.style.setProperty('--dx',Math.cos(ang)*dist+'px'); sp.style.setProperty('--dy',Math.sin(ang)*dist+'px'); dom.fx.appendChild(sp); setTimeout(()=>sp.remove(),700);
        }
      }
      function cleanupEffects(){ document.querySelectorAll('.white-flash,.burst,.confetti,.spark,.slash-effect').forEach(n=>n.remove()); dom.fx.innerHTML=''; if(dom.bossimg) dom.bossimg.classList.remove('defeated'); unlockLayout(); }

      /* ---------- ã‚¤ãƒ™ãƒ³ãƒˆ ---------- */
      function bindEvents(){
        dom.gradeBtns.forEach(btn=>btn.addEventListener('click',()=>selectGrade(btn.dataset.grade)));
        dom.username.addEventListener('input',updateStartButton);
        dom.startgamebtn.addEventListener('click',()=>{ app.user.name=dom.username.value.trim(); app.progress.bossIndex=0; app.progress.bossOrder=shuffle([...Array(BOSS_LIST.length).keys()]); setBossAndResetSession(); enterGame(); debounceSave(); });
        dom.startbtn.addEventListener('click',startQuest);
        dom.nextbtn.addEventListener('click',startQuest);
        dom.resetbtn.addEventListener('click',()=>{ if(app.game.bossHp===0){ advanceBoss(); } else { resetSession(); dom.resulttext.textContent='æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ï¼'; dom.startbtn.style.display='inline-block'; dom.nextbtn.style.display='none'; }});
        dom.backbtn.addEventListener('click',enterSetup);

        document.addEventListener('keydown',(e)=>{
          if(e.key>='1'&&e.key<='4'){ const idx=+e.key-1; const b=dom.optionscontainer?.querySelectorAll('.option-btn')[idx]; if(b && !b.disabled) b.click(); }
          const k=e.key.toLowerCase(); if(k==='s' && dom.startbtn.style.display!=='none') dom.startbtn.click(); if(k==='n' && dom.nextbtn.style.display!=='none') dom.nextbtn.click(); if(k==='b') dom.backbtn.click();
        });
      }

      /* ---------- èµ·å‹• ---------- */
      function init(){ initializeDOM(); bindEvents(); updateStartButton(); enterSetup(); const n=$('boot-note'); if(n) n.remove(); }
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',init); } else { init(); }
    }catch(err){
      const n=document.getElementById('boot-note'); if(n){ n.textContent='åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: '+err.message; n.classList.add('error'); }
      console.error(err);
    }
  })();
  </script>
</body>
</html>

