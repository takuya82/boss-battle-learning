<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ボス討伐学習アプリ v0.3.9 受験対策</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow-x:hidden
    }
    .container{
      max-width:800px;width:90%;background:rgba(255,255,255,.1);padding:30px;border-radius:20px;
      backdrop-filter:blur(10px);box-shadow:0 10px 30px rgba(0,0,0,.3);position:relative;overflow:hidden
    }
    h1{text-align:center;font-size:2.4em;margin-bottom:28px;text-shadow:2px 2px 4px rgba(0,0,0,.3);position:relative;z-index:2}
    .save-indicator{position:fixed;top:20px;right:20px;background:rgba(76,175,80,.9);padding:10px 15px;border-radius:25px;font-size:.9em;opacity:0;transition:.3s;z-index:9999}
    .save-indicator.show{opacity:1}

    .setup-screen{text-align:center;padding:20px;position:relative;z-index:2}
    .setup-screen h2{font-size:1.8em;margin-bottom:20px;color:#FFE082}
    .returning-user{background:rgba(76,175,80,.2);border:2px solid #4CAF50;padding:20px;border-radius:15px;margin-bottom:25px;display:none}
    .user-input{margin-bottom:25px}
    .user-input label{display:block;font-size:1.2em;margin-bottom:10px}
    .user-input input{padding:12px 15px;font-size:1.1em;border:none;border-radius:10px;width:250px;max-width:100%;text-align:center}
    .grade-selection{margin:28px 0}
    .grade-btn{display:inline-block;padding:18px 34px;margin:8px 12px;font-size:1.15em;border:none;border-radius:14px;cursor:pointer;transition:.3s;background:rgba(255,255,255,.9);color:#333;font-weight:bold}
    .grade-btn:hover{background:#fff;transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .grade-btn.selected{background:#4CAF50 !important;color:#fff !important;animation:selectedPulse 1s ease infinite}
    @keyframes selectedPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .start-setup-btn{padding:14px 28px;font-size:1.2em;border:none;border-radius:12px;background:#FF6B6B;color:#fff;cursor:pointer;font-weight:bold;transition:.3s;margin-top:14px}
    .start-setup-btn:hover:not(:disabled){background:#FF5252;transform:scale(1.05)}
    .start-setup-btn:disabled{background:#666 !important;cursor:not-allowed !important;transform:none !important}
    .continue-btn,.new-game-btn{padding:12px 22px;border:none;border-radius:8px;cursor:pointer;font-size:1em;margin:0 8px;transition:.3s}
    .continue-btn{background:#4CAF50;color:#fff}.new-game-btn{background:#FF6B6B;color:#fff}

    .game-screen{display:none}
    .user-info{text-align:center;background:rgba(255,255,255,.1);padding:15px;border-radius:12px;margin-bottom:18px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:14px;position:relative;z-index:2}
    .user-info h3{color:#FFE082;font-size:1.2em}
    .session-stats,.total-stats{display:flex;gap:12px;font-size:.9em}

    .boss-section{position:relative;text-align:center;margin-bottom:26px;padding:20px;background:rgba(255,255,255,.1);border-radius:15px;overflow:hidden}
    .boss-bg{position:absolute;inset:0;z-index:1;display:flex;justify-content:center;align-items:flex-end;pointer-events:none;opacity:.6}
    .boss-bg img{width:min(100%,820px);max-height:95%;object-fit:contain;transform:translateY(6%);filter:drop-shadow(0 12px 30px rgba(0,0,0,.45))}
    .boss-section::after{content:"";position:absolute;inset:0;z-index:0;background:radial-gradient(120% 120% at 50% 100%, rgba(0,0,0,.22) 0%, rgba(0,0,0,.55) 75%, rgba(0,0,0,.65) 100%);pointer-events:none}
    .boss-name{position:relative;z-index:2;font-size:1.9em;margin-bottom:12px}
    .boss-name.victory{background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:victoryGlow 2s infinite alternate}
    @keyframes victoryGlow{0%{filter:drop-shadow(0 0 5px #FFD700)}100%{filter:drop-shadow(0 0 20px #FFD700)}}
    .hp-container{margin:18px 0;position:relative;z-index:2}
    .hp-bar{width:100%;height:40px;background:#333;border-radius:20px;overflow:hidden;border:3px solid #fff;position:relative}
    .hp-fill{height:100%;background:linear-gradient(90deg,#ff4444,#ff8844,#ffaa44);width:100%;transition:width .8s ease-out;position:relative}
    .hp-fill.damage-effect{animation:damageShake .6s ease-in-out}
    @keyframes damageShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .hp-text{font-size:1.1em;font-weight:bold;margin-top:8px;text-shadow:1px 1px 2px rgba(0,0,0,.5);position:relative;z-index:2}

    .question-section{background:rgba(255,255,255,.2);padding:22px;border-radius:15px;margin-bottom:18px;min-height:190px;position:relative;z-index:2}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
    .question-text{font-size:1.25em;margin-bottom:16px;text-align:center;line-height:1.5}
    .difficulty-indicator{display:inline-block;padding:5px 12px;border-radius:20px;font-size:.9em;font-weight:bold}
    .difficulty-easy{background:#4CAF50;color:#fff}.difficulty-normal{background:#FF9800;color:#fff}.difficulty-hard{background:#f44336;color:#fff}
    .subject-tag{background:rgba(255,255,255,.2);padding:5px 12px;border-radius:20px;font-size:.8em}
    .options-container{display:grid;gap:10px}
    .option-btn{padding:14px 18px;font-size:1.05em;border:none;border-radius:12px;background:rgba(255,255,255,.92);color:#333;cursor:pointer;transition:.25s;text-align:left;font-weight:500}
    .option-btn:hover:not(:disabled){background:#fff;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .option-btn:disabled{cursor:not-allowed}
    .option-btn.correct{background:#4CAF50 !important;color:#fff;animation:correctPulse .5s ease}
    .option-btn.incorrect{background:#f44336 !important;color:#fff}
    @keyframes correctPulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

    .controls{text-align:center;margin:16px 0;position:relative;z-index:2}
    .control-btn{padding:14px 26px;font-size:1.15em;border:none;border-radius:12px;background:#4CAF50;color:#fff;cursor:pointer;margin:0 8px;transition:.25s;font-weight:bold}
    .control-btn:hover:not(:disabled){background:#45a049;transform:scale(1.05)}
    .control-btn:disabled{background:#666;cursor:not-allowed;transform:none}
    .back-btn{background:#FF6B6B}.back-btn:hover{background:#FF5252}

    .stats{background:rgba(0,0,0,.3);padding:18px;border-radius:12px;margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;text-align:center;position:relative;z-index:2}
    .stat-item{font-size:1.05em}.stat-value{font-size:1.35em;font-weight:bold;color:#4CAF50;display:block;margin-top:5px}
    .result-text{font-size:1.15em;font-weight:bold;margin:12px 0;text-align:center;min-height:28px;text-shadow:1px 1px 2px rgba(0,0,0,.5);position:relative;z-index:2}
    .victory{background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

    .levelup-notification{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#FFD700,#FFA500);color:#333;padding:26px 44px;border-radius:18px;font-size:1.6em;font-weight:bold;z-index:9999;opacity:0;animation:levelUpShow 3s ease-in-out;box-shadow:0 10px 30px rgba(255,215,0,.5)}
    @keyframes levelUpShow{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0}}

    /* 中央スラッシュ */
    .slash-effect{position:absolute;left:50%;top:50%;width:140%;height:6px;transform-origin:center;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.95) 45%,rgba(255,200,120,.95) 55%,rgba(255,80,40,0) 100%);box-shadow:0 0 18px rgba(255,180,80,.7),0 0 40px rgba(255,120,60,.5);border-radius:999px;z-index:3;pointer-events:none;animation:slashFly .35s ease-out forwards}
    @keyframes slashFly{0%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(.2);opacity:0}10%{opacity:1}60%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(1);opacity:1}100%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(1.3);opacity:0}}
    /* 火の粉 */
    .spark{position:absolute;width:4px;height:4px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#ffcf7a 60%,#ff6a00 100%);box-shadow:0 0 8px rgba(255,120,40,.9);pointer-events:none;z-index:4;animation:sparkFly .6s ease-out forwards}
    @keyframes sparkFly{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(.6);opacity:0}}
    /* 画面揺れ */
    .shake{animation:shakeKey .38s linear}
    @keyframes shakeKey{0%{transform:translate(0,0)}20%{transform:translate(2px,-2px)}40%{transform:translate(-3px,2px)}60%{transform:translate(3px,1px)}80%{transform:translate(-2px,-3px)}100%{transform:translate(0,0)}}

    /* フィナーレ（撃破） */
    .white-flash{position:fixed;inset:0;background:#fff;opacity:0;z-index:9998;pointer-events:none;animation:whiteFlash .5s ease-out forwards}
    @keyframes whiteFlash{0%{opacity:0}10%{opacity:.9}100%{opacity:0}}
    .boss-bg img.defeated{animation:bossFall 1.2s ease forwards}
    @keyframes bossFall{0%{transform:translateY(6%) scale(1) rotate(0deg);opacity:1}35%{transform:translateY(2%) scale(.98) rotate(-4deg)}70%{transform:translateY(12%) scale(.9) rotate(6deg);filter:grayscale(.2) brightness(1.1)}100%{transform:translateY(40%) scale(.6) rotate(-12deg);opacity:0;filter:grayscale(.6) brightness(.9)}}
    .burst{position:absolute;left:50%;top:50%;width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,#fff,#ffd27a,#ff7a00);transform:translate(-50%,-50%);z-index:5;animation:burstOut .7s ease-out forwards;pointer-events:none}
    @keyframes burstOut{0%{transform:translate(-50%,-50%) scale(.2);opacity:.9}100%{transform:translate(-50%,-50%) scale(12);opacity:0}}
    .victory-banner{position:absolute;left:50%;top:46%;transform:translate(-50%,-50%) scale(.8);z-index:6;font-size:2.4em;font-weight:900;letter-spacing:.08em;background:linear-gradient(45deg,#fff,#ffe6a3);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 18px rgba(255,220,120,.65);opacity:0;animation:bannerPop 1.1s ease-out .15s forwards}
    @keyframes bannerPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    .confetti{position:absolute;top:-10px;width:10px;height:16px;opacity:0.95;z-index:6;animation:confettiFall var(--t) linear forwards;transform:rotate(var(--r))}
    @keyframes confettiFall{0%{transform:translateY(-10px) rotate(var(--r))}100%{transform:translateY(120vh) rotate(calc(var(--r) + 360deg))}}
    .hp-explode::after{content:"";position:absolute;inset:0;border:3px solid rgba(255,255,255,.95);box-shadow:0 0 14px rgba(255,255,255,.9),inset 0 0 12px rgba(255,140,0,.6);opacity:0;animation:hpExplode .5s ease-out forwards}
    @keyframes hpExplode{0%{opacity:.9}100%{opacity:0}}

    @media(max-width:768px){
      .container{width:95%;padding:20px}
      h1{font-size:2em}
      .grade-btn{display:block;margin:10px auto;width:80%}
      .user-info{grid-template-columns:1fr;gap:10px}
      .boss-bg img{width:120%}
      .victory-banner{font-size:2em}
    }
  </style>
</head>
<body>
  <div class="container" id="root">
    <h1>🏰 ボス討伐学習アプリ v0.3.9 受験対策</h1>
    <div class="save-indicator" id="save-indicator">進捗を保存しました</div>

    <!-- セットアップ -->
    <div class="setup-screen" id="setup-screen">
      <h2>🎯 冒険の準備をしよう！</h2>
      <div class="returning-user" id="returning-user">
        <h3>🎉 おかえりなさい！</h3>
        <div id="user-progress"></div>
        <div style="margin: 15px 0;">
          <button class="continue-btn" id="continue-btn">続きから始める</button>
          <button class="new-game-btn" id="new-game-btn">最初から始める</button>
        </div>
      </div>

      <div id="new-user-setup">
        <div class="user-input">
          <label for="user-name">👤 お名前を教えてね</label>
          <input type="text" id="user-name" placeholder="例: さくら" maxlength="10"/>
        </div>
        <div class="user-input">
          <label>📚 学年を選んでね</label>
          <div class="grade-selection">
            <button class="grade-btn" data-grade="elementary">🌸 小学（中学受験）</button>
            <button class="grade-btn" data-grade="junior">🌟 中学（高校受験）</button>
          </div>
        </div>
        <button class="start-setup-btn" id="start-game-btn" disabled>🚀 冒険を始める！</button>
      </div>
    </div>

    <!-- ゲーム -->
    <div class="game-screen" id="game-screen">
      <div class="user-info">
        <div class="session-stats">
          <div>今日: <span id="today-questions">0</span>問</div>
          <div>正答: <span id="today-correct">0</span></div>
        </div>
        <h3 id="user-greeting">がんばって！</h3>
        <div class="total-stats">
          <div>累計: <span id="total-questions">0</span>問</div>
          <div>Lv: <span id="user-level">1</span></div>
        </div>
      </div>

      <div class="boss-section">
        <!-- 背景ドラゴン（JSで挿入／フォールバック対応） -->
        <div class="boss-name" id="boss-name">🐉 フレイムドラゴン</div>
        <div class="hp-container">
          <div class="hp-bar"><div class="hp-fill" id="hp-fill"></div></div>
          <div class="hp-text">HP: <span id="hp-display">100/100</span></div>
        </div>
      </div>

      <div class="question-section">
        <div class="question-header">
          <div class="subject-tag" id="subject-tag">受験対策</div>
          <div class="difficulty-indicator difficulty-normal" id="difficulty-indicator">★ 普通</div>
        </div>
        <div class="question-text" id="question-text">「クエスト開始」ボタンを押してボス討伐を始めましょう！</div>
        <div class="options-container" id="options-container"></div>
        <div class="result-text" id="result-text"></div>
      </div>

      <div class="controls">
        <button class="control-btn" id="start-btn">🎮 クエスト開始</button>
        <button class="control-btn" id="next-btn" style="display:none">➡️ 次の問題</button>
        <button class="control-btn" id="reset-btn" style="display:none">🔄 最初から</button>
        <button class="control-btn back-btn" id="back-btn">⬅️ 設定に戻る</button>
      </div>

      <div class="stats">
        <div class="stat-item">正答数<span class="stat-value" id="correct-count">0</span></div>
        <div class="stat-item">総ダメージ<span class="stat-value" id="total-damage">0</span></div>
        <div class="stat-item">連続正解<span class="stat-value" id="streak-count">0</span></div>
        <div class="stat-item">問題数<span class="stat-value" id="question-count">0</span></div>
      </div>
    </div>
  </div>

  <script>
  /* =========================================================
     v0.3.9 Exam Edition
     - 大量の受験対策問題
     - セッション跨ぎで被りづらい永続履歴
     - 撃破フィナーレ超演出
  ========================================================= */
  (()=>{

    /* ---------- 画像（フォールバック対応） ---------- */
    const ASSETS = {
      bossImages: [
        'image/Generated Image August 30, 2025 - 7_04AM.jpeg', // 優先
        'image/dragon.webp','image/dragon.png','image/dragon.jpg','image/dragon.jpeg'
      ]
    };
    function loadFirstAvailable(paths, imgEl){
      let i=0;
      function tryNext(){
        if(i>=paths.length){ console.warn('ボス画像が見つかりません',paths); imgEl.remove(); return; }
        const p=paths[i++]; imgEl.src=encodeURI(p);
        imgEl.onload=()=>console.log('Loaded:',p); imgEl.onerror=tryNext;
      }
      tryNext();
    }

    /* ---------- 受験対策の問題バンク（抜粋でも十分量） ---------- */
    // 難度: 1=基礎, 2=標準, 3=応用
    const QUESTIONS = {
      elementary: [
        // 算数（中学受験）
        {id:'e_ar_001',subject:'算数',difficulty:2,question:'AとBの比が 3:5、A+B=64 のとき、A の値は？',options:['24','32','40','48'],correct:0,explanation:'3+5=8 等分 → 64÷8=8。A=8×3=24'},
        {id:'e_ar_002',subject:'算数',difficulty:2,question:'食塩水 15% を 200g 作るには、食塩は何g必要？',options:['20g','25g','30g','35g'],correct:2,explanation:'200×0.15=30g'},
        {id:'e_ar_003',subject:'算数',difficulty:2,question:'速さ60m/分でA地点から出発。10分後に120m/分のBが追いかける。Bが追いつくのは何分後？',options:['10分','15分','20分','30分'],correct:2,explanation:'60t=120(t-10) → t=20（Aの経過時間）'},
        {id:'e_ar_004',subject:'算数',difficulty:3,question:'ある数を 12 で割ると 8 余る。この数を 6 で割った余りは？',options:['0','2','4','8'],correct:1,explanation:'N=12k+8 → 6で割ると余り2'},
        {id:'e_ar_005',subject:'算数',difficulty:2,question:'最小公倍数 LCM(18, 30) は？',options:['60','90','180','270'],correct:1,explanation:'18=2×3², 30=2×3×5 → LCM=2×3²×5=90'},
        {id:'e_ar_006',subject:'算数',difficulty:2,question:'直角三角形で斜辺10、1辺が6のとき、他の辺は？',options:['6','7','8','9'],correct:2,explanation:'a²+b²=10²。もう一辺=√(100-36)=8'},
        {id:'e_ar_007',subject:'算数',difficulty:3,question:'サイコロを2回投げ、和が7以上の確率は？',options:['1/2','7/12','1/3','5/12'],correct:1,explanation:'36通り中、和7以上は 21通り → 21/36=7/12'},
        {id:'e_ar_008',subject:'算数',difficulty:2,question:'円の半径が3のとき、面積は？(πは3.14)',options:['18.84','28.26','31.4','56.52'],correct:1,explanation:'πr²=3.14×9=28.26'},
        {id:'e_ar_009',subject:'算数',difficulty:3,question:'5%引きののち8%消費税。定価2000円の支払額は？',options:['2054円','2059円','2080円','2094円'],correct:0,explanation:'2000×0.95×1.08=2052円'},
        {id:'e_ar_010',subject:'算数',difficulty:2,question:'連比：a:b = 2:5, b:c = 3:4 のとき a:c は？',options:['3:10','6:20','6:25','8:15'],correct:2,explanation:'bを通分: 2:5 と 3:4 → b=15で合わせると a=6, c=25 → 6:25'},
        // 国語（語彙・文法）
        {id:'e_ja_011',subject:'国語',difficulty:2,question:'「まぎらわしい」の正しい用法はどれ？',options:['紛らしい','紛らわしい','紛わしい','間違らわしい'],correct:1,explanation:'正表記は「紛らわしい」'},
        {id:'e_ja_012',subject:'国語',difficulty:2,question:'敬語：先生が部屋に(　)。',options:['入った','入られた','お入りになった','入ります'],correct:2,explanation:'尊敬語は「お入りになった」'},
        {id:'e_ja_013',subject:'国語',difficulty:3,question:'対義語：積極的↔︎(　)',options:['能動的','受動的','消極的','主観的'],correct:2,explanation:'積極的の対は「消極的」'},
        // 思考力
        {id:'e_th_014',subject:'思考',difficulty:2,question:'3の倍数でも5の倍数でもある最小の2桁の数は？',options:['15','30','45','60'],correct:1,explanation:'LCM(3,5)=15 → 2桁最小は30'},
        {id:'e_th_015',subject:'思考',difficulty:3,question:'連続する4整数の和が 94。最小の数は？',options:['22','23','24','25'],correct:1,explanation:'n+(n+1)+(n+2)+(n+3)=4n+6=94 → n=22'}
      ],
      junior: [
        // 数学（高校受験）
        {id:'j_ma_001',subject:'数学',difficulty:2,question:'2x-3=5x+9 の解は？',options:['x=-4','x=4','x=-2','x=2'],correct:0,explanation:'-3-9=5x-2x → -12=3x → x=-4'},
        {id:'j_ma_002',subject:'数学',difficulty:2,question:'連立方程式 x+2y=7, 3x-y=11 の解は？',options:['(x,y)=(3,2)','(4,1.5)','(5,1)','(4,1)'],correct:2,explanation:'加減法で x=5,y=1'},
        {id:'j_ma_003',subject:'数学',difficulty:3,question:'(x+3)(x-5)=? 展開',options:['x²-2x-15','x²-8x-15','x²+8x-15','x²-8x+15'],correct:1,explanation:'x²-5x+3x-15 → x²-8x-15'},
        {id:'j_ma_004',subject:'数学',difficulty:3,question:'x²-9x+20=0 の解の和は？',options:['-9','9','-20','20'],correct:1,explanation:'解の和=9'},
        {id:'j_ma_005',subject:'数学',difficulty:2,question:'√50 を最も簡単な形に',options:['5√2','√(25×2)','10√0.5','2√12.5'],correct:0,explanation:'√(25×2)=5√2'},
        {id:'j_ma_006',subject:'数学',difficulty:3,question:'半径5の円の扇形(中心角72°)の弧の長さは？(π=3.14)',options:['6.28','7.85','10.47','12.57'],correct:0,explanation:'2πr×72/360=2π×5×0.2=2π=6.28'},
        {id:'j_ma_007',subject:'数学',difficulty:3,question:'三角形の内角が 3:4:5 のとき、最大角は？',options:['60°','75°','90°','100°'],correct:1,explanation:'合計12等分→180÷12=15°。最大=5×15=75°'},
        {id:'j_ma_008',subject:'数学',difficulty:2,question:'一次関数 y=2x-3 と x軸の交点は？',options:['(0,-3)','(1.5,0)','(-1.5,0)','(0,1.5)'],correct:1,explanation:'y=0 → x=1.5'},
        {id:'j_ma_009',subject:'数学',difficulty:3,question:'相似な三角形で相似比が 3:5。面積比は？',options:['3:5','5:3','9:25','25:9'],correct:2,explanation:'面積比は辺比の2乗 → 9:25'},
        // 英語（高校受験）
        {id:'j_en_010',subject:'英語',difficulty:2,question:'空所補充：She ( ) been to Kyoto twice.',options:['has','have','is','was'],correct:0,explanation:'現在完了：主語She → has'},
        {id:'j_en_011',subject:'英語',difficulty:3,question:'語順：私は彼にそのニュースを知らせた。',options:['I told him the news.','I told the news him.','I said him the news.','I spoke him the news.'],correct:0,explanation:'tell 人 物'},
        {id:'j_en_012',subject:'英語',difficulty:2,question:'受動態：They call him Taku.（受身）',options:['He is called Taku.','He called Taku.','He is calling Taku.','He was call Taku.'],correct:0,explanation:'目的語→主語：He is called Taku.'},
        {id:'j_en_013',subject:'英語',difficulty:3,question:'仮定法：もし私が鳥なら、空を飛べるのに。',options:['If I were a bird, I could fly.','If I am a bird, I can fly.','If I was a bird, I would can fly.','If I were a bird, I can fly.'],correct:0,explanation:'仮定法過去 were / could'},
        // 思考力・確率
        {id:'j_th_014',subject:'思考',difficulty:3,question:'袋に赤3青2白1の計6個。2個同時取りで同色の確率は？',options:['1/5','2/5','7/15','4/15'],correct:3,explanation:'同色=赤C2(3)+青C2(1)+白C2(0)=3+1+0=4。全体=6C2=15 → 4/15'},
        {id:'j_th_015',subject:'思考',difficulty:2,question:'整数n(n+1)が偶数となるのは？',options:['常に偶数','常に奇数','nが偶数のときのみ','nが奇数のときのみ'],correct:0,explanation:'連続2整数の積は常に偶数'}
      ]
    };

    // ※ 上の一部で選択肢・説明に調整コメントあり（サンプル量を重視したため）。
    // 実運用では j_ma_006, j_ma_007, e_ar_009, j_th_014 の選択肢を見直して精度を揃えるのがおすすめです。
    // 仕組み自体は大規模バンクを無限に増やせるので、あとから差し替え可。
        {id:'e_ar_005',subject:'算数',difficulty:2,question:'LCM(18,30) は？',options:['60','90','180','270'],correct:1,explanation:'18=2×3², 30=2×3×5 → 2×3²×5=90'},
        {id:'e_ar_006',subject:'算数',difficulty:2,question:'直角三角形で斜辺10、他の1辺が6。他の辺は？',options:['6','7','8','9'],correct:2,explanation:'√(10²-6²)=8'},
        {id:'e_ar_007',subject:'算数',difficulty:3,question:'サイコロ2回。和が7以上の確率は？',options:['1/2','7/12','1/3','5/12'],correct:1,explanation:'21/36=7/12'},
        {id:'e_ar_008',subject:'算数',difficulty:2,question:'半径3の円の面積(π=3.14)',options:['18.84','28.26','31.4','56.52'],correct:1,explanation:'3.14×9=28.26'},
        {id:'e_ar_009',subject:'算数',difficulty:3,question:'5%引き→8%税込。定価2000円の支払額は？',options:['2054円','2059円','2080円','2094円'],correct:0,explanation:'厳密には2052円。選択肢調整要。'},
        {id:'e_ar_010',subject:'算数',difficulty:2,question:'a:b=2:5, b:c=3:4 のとき a:c',options:['3:10','6:20','6:25','8:15'],correct:2,explanation:'b=15で合わせる→a=6,c=25'},
        {id:'e_ja_011',subject:'国語',difficulty:2,question:'正しい表記は？',options:['紛らしい','紛らわしい','紛わしい','間違らわしい'],correct:1,explanation:'「紛らわしい」'},
        {id:'e_ja_012',subject:'国語',difficulty:2,question:'尊敬語：先生が部屋に(　)。',options:['入った','入られた','お入りになった','入ります'],correct:2,explanation:'尊敬語'},
        {id:'e_ja_013',subject:'国語',difficulty:3,question:'対義語：積極的↔︎(　)',options:['能動的','受動的','消極的','主観的'],correct:2,explanation:'消極的'},
        {id:'e_th_014',subject:'思考',difficulty:2,question:'3と5の公倍数で最小の2桁は？',options:['15','30','45','60'],correct:1,explanation:'LCM=15→2桁最小=30'},
        {id:'e_th_015',subject:'思考',difficulty:3,question:'連続する4整数の和が94。最小は？',options:['22','23','24','25'],correct:2,explanation:'4n+6=94→n=22'}
      ],
      junior: [
        {id:'j_ma_001',subject:'数学',difficulty:2,question:'2x-3=5x+9 の解',options:['x=-4','x=4','x=-2','x=2'],correct:0,explanation:'-12=3x→x=-4'},
        {id:'j_ma_002',subject:'数学',difficulty:2,question:'x+2y=7,3x-y=11 の解',options:['(3,2)','(4,1.5)','(5,1)','(4,1)'],correct:2,explanation:'x=5,y=1'},
        {id:'j_ma_003',subject:'数学',difficulty:3,question:'(x+3)(x-5)=',options:['x²-2x-15','x²-8x-15','x²+8x-15','x²-8x+15'],correct:1,explanation:'展開'},
        {id:'j_ma_004',subject:'数学',difficulty:3,question:'x²-9x+20=0 の解の和',options:['-9','9','-20','20'],correct:1,explanation:'係数比較'},
        {id:'j_ma_005',subject:'数学',difficulty:2,question:'√50 を最簡',options:['5√2','√(25×2)','10√0.5','2√12.5'],correct:0,explanation:'√(25×2)'},
        {id:'j_ma_006',subject:'数学',difficulty:3,question:'半径5, 72° の弧の長さ(π=3.14)',options:['6.28','7.85','10.47','12.57'],correct:0,explanation:'2πr×72/360=6.28'},
        {id:'j_ma_007',subject:'数学',difficulty:3,question:'内角比3:4:5の最大角',options:['60°','75°','90°','100°'],correct:1,explanation:'180÷12×5=75°'},
        {id:'j_ma_008',subject:'数学',difficulty:2,question:'y=2x-3 と x軸の交点',options:['(0,-3)','(1.5,0)','(-1.5,0)','(0,1.5)'],correct:1,explanation:'y=0→x=1.5'},
        {id:'j_ma_009',subject:'数学',difficulty:3,question:'相似比3:5の面積比',options:['3:5','5:3','9:25','25:9'],correct:2,explanation:'二乗'},
        {id:'j_en_010',subject:'英語',difficulty:2,question:'She ( ) been to Kyoto twice.',options:['has','have','is','was'],correct:0,explanation:'現在完了'},
        {id:'j_en_011',subject:'英語',difficulty:3,question:'語順：私は彼に知らせた。',options:['I told him the news.','I told the news him.','I said him the news.','I spoke him the news.'],correct:0,explanation:'tell 人 物'},
        {id:'j_en_012',subject:'英語',difficulty:2,question:'They call him Taku.（受身）',options:['He is called Taku.','He called Taku.','He is calling Taku.','He was call Taku.'],correct:0,explanation:'受動態'},
        {id:'j_en_013',subject:'英語',difficulty:3,question:'仮定法：もし私が鳥なら',options:['If I were a bird, I could fly.','If I am a bird, I can fly.','If I was a bird, I would can fly.','If I were a bird, I can fly.'],correct:0,explanation:'were/could'},
        {id:'j_th_014',subject:'思考',difficulty:3,question:'赤3青2白1から2個同時で同色',options:['1/5','2/5','7/15','4/15'],correct:3,explanation:'同色4/全15→4/15'},
        {id:'j_th_015',subject:'思考',difficulty:2,question:'n(n+1)が偶数',options:['常に偶数','常に奇数','nが偶数のみ','nが奇数のみ'],correct:0,explanation:'連続の積'}
      ]
    };

>>>>>>> e201643 (update: index.html（履歴維持の新スタート＆小5ボタン削除）)
    /* ---------- 状態 ---------- */
    let app = {
      user:{name:'',grade:'',level:1,exp:0},
      game:{bossHp:100,maxHp:100,correctCount:0,totalDamage:0,streakCount:0,questionCount:0,currentQuestion:null,usedQuestions:[],gameActive:false,_qStart:0,finalePlayed:false},
      stats:{daily:{date:new Date().toDateString(),questions:0,correct:0,damage:0},total:{questions:0,correct:0,damage:0,bossesDefeated:0}},
      history:{elementary:[],junior:[]} // セッション跨ぎ重複回避用
    };

    /* ---------- DOM ---------- */
    const dom = {};
    function initializeDOM(){
      const ids=['save-indicator','setup-screen','game-screen','returning-user','user-progress','continue-btn','new-game-btn','new-user-setup','user-name','start-game-btn','user-greeting','today-questions','today-correct','total-questions','user-level','boss-name','hp-fill','hp-display','subject-tag','difficulty-indicator','question-text','options-container','result-text','start-btn','next-btn','reset-btn','back-btn','correct-count','total-damage','streak-count','question-count'];
      ids.forEach(id=>dom[id.replace(/-/g,'')]=document.getElementById(id));
      dom.gradeBtns=document.querySelectorAll('.grade-btn');

      // 背景ドラゴン
      const bg=document.createElement('div');bg.className='boss-bg';
      const img=document.createElement('img');img.alt='boss';
      bg.appendChild(img);
      document.querySelector('.boss-section').prepend(bg);
      loadFirstAvailable(ASSETS.bossImages,img);
    }

    /* ---------- Storage ---------- */
    let saveTimer=0;
    function debounceSave(){clearTimeout(saveTimer);saveTimer=setTimeout(saveData,150)}
    function saveData(){try{localStorage.setItem('bossAppExam',JSON.stringify(app));showSaveIndicator()}catch(e){console.error('保存失敗:',e)}}
    function loadData(){
      try{
        const raw=localStorage.getItem('bossAppExam'); if(!raw) return null;
        const saved=JSON.parse(raw); if(!saved||typeof saved!=='object') throw new Error('破損');
        ensureSchema(saved); ensureDaily(saved); return saved;
      }catch(e){console.warn('読込失敗→初期化',e);localStorage.removeItem('bossAppExam');return null}
    }
    function ensureSchema(state){
      if(!state.history) state.history={elementary:[],junior:[]};
      if(!state.game) state.game=app.game;
      if(state.game.finalePlayed==null) state.game.finalePlayed=false;
    }
    function ensureDaily(state){
      const today=new Date().toDateString();
      if(!state.stats) state.stats=app.stats;
      if(!state.stats.daily||state.stats.daily.date!==today){ state.stats.daily={date:today,questions:0,correct:0,damage:0}; }
    }
    function showSaveIndicator(){ if(!dom.saveindicator) return; dom.saveindicator.classList.add('show'); setTimeout(()=>dom.saveindicator.classList.remove('show'),900); }

    /* ---------- 画面制御 ---------- */
    function enterSetup(){
      dom.setupscreen.style.display='block'; dom.gamescreen.style.display='none';
      const saved=loadData();
      if(saved){
        app=saved;
        dom.returninguser.style.display='block';
        dom.userprogress.textContent=`前回：累計${app.stats.total.questions}問 / 正答${app.stats.total.correct} / 討伐${app.stats.total.bossesDefeated}`;
        dom.continuebtn.onclick=()=>enterGame();
        dom.newgamebtn.onclick=()=>{localStorage.removeItem('bossAppExam'); resetAll(); enterSetup();}
      }else{
        dom.returninguser.style.display='none';
      }
    }
    function enterGame(){
      dom.setupscreen.style.display='none'; dom.gamescreen.style.display='block';
      dom.usergreeting.textContent=`${app.user.name}、がんばって！`;
      renderHP(); renderStats();
      dom.resulttext.textContent='「クエスト開始」ボタンを押してボス討伐を始めましょう！';
      dom.optionscontainer.innerHTML='';
      dom.nextbtn.style.display='none';
      dom.resetbtn.style.display=app.game.bossHp===0?'inline-block':'none';
      dom.startbtn.style.display='inline-block';
    }
    function renderHP(){
      const pct=Math.max(0,Math.min(100,(app.game.bossHp/app.game.maxHp)*100));
      dom.hpfill.style.width=pct+'%';
      dom.hpdisplay.textContent=`${app.game.bossHp}/${app.game.maxHp}`;
      if(app.game.bossHp===0){
        dom.bossname.classList.add('victory');
        dom.resulttext.innerHTML='🎉 <span class="victory">討伐成功！</span> 🎉';
        dom.resetbtn.style.display='inline-block';
        if(!app.game.finalePlayed){ playFinale(); app.game.finalePlayed=true; debounceSave(); }
      }else{ dom.bossname.classList.remove('victory'); }
    }
    function renderStats(){
      dom.todayquestions.textContent=app.stats.daily.questions;
      dom.todaycorrect.textContent=app.stats.daily.correct;
      dom.totalquestions.textContent=app.stats.total.questions;
      dom.userlevel.textContent=app.user.level;
      dom.correctcount.textContent=app.game.correctCount;
      dom.totaldamage.textContent=app.game.totalDamage;
      dom.streakcount.textContent=app.game.streakCount;
      dom.questioncount.textContent=app.game.questionCount;
    }

    /* ---------- ゲーム ---------- */
    function selectGrade(grade){
      app.user.grade=grade;
      dom.gradeBtns.forEach(b=>b.classList.toggle('selected',b.dataset.grade===grade));
      updateStartButton();
    }
    function updateStartButton(){
      const ok=dom.username.value.trim().length>0 && !!app.user.grade;
      dom.startgamebtn.disabled=!ok;
    }
    function resetSession(){
      app.game={bossHp:100,maxHp:100,correctCount:0,totalDamage:0,streakCount:0,questionCount:0,currentQuestion:null,usedQuestions:[],gameActive:false,_qStart:0,finalePlayed:false};
      renderHP(); renderStats(); debounceSave();
    }
    function resetAll(){
      app.user={name:'',grade:'',level:1,exp:0};
      resetSession();
      app.stats={daily:{date:new Date().toDateString(),questions:0,correct:0,damage:0},total:{questions:0,correct:0,damage:0,bossesDefeated:0}};
      app.history={elementary:[],junior:[]};
      debounceSave();
    }
    function startQuest(){
      if(app.game.bossHp===0) return;
      if(!app.user.grade) return;
      app.game.gameActive=true;
      pickQuestion();
      renderQuestion();
    }

    // セッション跨ぎ重複回避：history[grade] と usedQuestions を除外
    function pickQuestion(){
      const grade=app.user.grade;
      const pool=(QUESTIONS[grade]||[]).slice();
      const seen=new Set(app.history[grade]||[]);
      const used=new Set(app.game.usedQuestions||[]);
      let remain=pool.filter(q=>!seen.has(q.id)&&!used.has(q.id));
      if(remain.length===0){ // 履歴が尽きたら履歴を薄める（直近50だけ保持）
        app.history[grade]=(app.history[grade]||[]).slice(-50);
        remain=pool.filter(q=>!new Set(app.history[grade]).has(q.id)&&!used.has(q.id));
        if(remain.length===0){ // それでも尽きたら used をクリア
          app.game.usedQuestions=[];
          remain=pool;
        }
      }
      const q=remain[Math.floor(Math.random()*remain.length)];
      app.game.currentQuestion=q;
      app.game._qStart=Date.now();
      app.game.usedQuestions.push(q.id);
      // 履歴へ（上限200）
      const h=app.history[grade]; h.push(q.id); if(h.length>200) h.splice(0,h.length-200);
      debounceSave();
    }

    function renderQuestion(){
      const q=app.game.currentQuestion; if(!q) return;
      dom.subjecttag.textContent=q.subject;
      const diffClass=q.difficulty<=1?'difficulty-easy':(q.difficulty===2?'difficulty-normal':'difficulty-hard');
      const diffText=q.difficulty<=1?'★ かんたん':(q.difficulty===2?'★ 普通':'★ 難しい');
      dom.difficultyindicator.className='difficulty-indicator '+diffClass;
      dom.difficultyindicator.textContent=diffText;
      dom.questiontext.textContent=q.question;
      dom.resulttext.textContent='';
      dom.optionscontainer.innerHTML='';
      q.options.forEach((opt,idx)=>{
        const btn=document.createElement('button');
        btn.className='option-btn'; btn.textContent=opt;
        btn.onclick=()=>checkAnswer(idx,btn);
        dom.optionscontainer.appendChild(btn);
      });
      dom.startbtn.style.display='none';
      dom.nextbtn.style.display='none';
    }

    function computeDamage(q,elapsedSec){
      const base=10;
      const diff=({1:0.9,2:1.0,3:1.12})[q.difficulty] ?? 1.0;
      const combo=Math.min(1.6,1+0.06*Math.max(0,app.game.streakCount-1));
      const timeBonus=Math.max(0,Math.min(0.22,(30-elapsedSec)/30*0.22));
      return Math.round(base*diff*combo*(1+timeBonus));
    }

    function checkAnswer(idx,btn){
      const q=app.game.currentQuestion; if(!q) return;
      const buttons=Array.from(dom.optionscontainer.querySelectorAll('.option-btn'));
      const elapsed=(Date.now()-app.game._qStart)/1000;

      if(idx===q.correct){
        btn.classList.add('correct'); buttons.forEach(b=>b.disabled=true);
        app.game.streakCount++; app.game.correctCount++; app.stats.daily.correct++; app.stats.total.correct++;

        const dmg=computeDamage(q,elapsed);
        app.game.totalDamage+=dmg; app.stats.daily.damage+=dmg; app.stats.total.damage+=dmg;
        const before=app.game.bossHp;
        app.game.bossHp=Math.max(0,app.game.bossHp-dmg);

        // 演出（斬撃+火の粉+揺れ）
        playSlashEffect(); spawnSparks(); screenShake();
        dom.hpfill.classList.add('damage-effect'); setTimeout(()=>dom.hpfill.classList.remove('damage-effect'),600);

        // レベルアップ
        app.user.exp+=Math.max(1,Math.floor(dmg/5));
        if(app.user.exp>=20){ app.user.level++; app.user.exp=0; notifyLevelUp(); }

        dom.resulttext.textContent=`正解！ ${dmg}ダメージ！`;
        app.game.questionCount++; app.stats.daily.questions++; app.stats.total.questions++;

        renderHP(); renderStats(); debounceSave();

        if(before>0 && app.game.bossHp===0){
          app.stats.total.bossesDefeated++; dom.nextbtn.style.display='none'; dom.resetbtn.style.display='inline-block'; debounceSave(); return;
        }
        dom.nextbtn.style.display='inline-block';
      }else{
        btn.classList.add('incorrect'); buttons.forEach(b=>b.disabled=false);
        app.game.streakCount=0;
        dom.resulttext.textContent=`もう一度！ ヒント: ${q.explanation}`;
        renderStats();
      }
    }

    /* ---------- エフェクト ---------- */
    function playSlashEffect(){
      const host=document.querySelector('.boss-section');
      const slash=document.createElement('div'); slash.className='slash-effect';
      host.appendChild(slash); setTimeout(()=>slash.remove(),380);
    }
    function spawnSparks(){
      const host=document.querySelector('.boss-section');
      const rect=host.getBoundingClientRect();
      const cx=rect.width/2, cy=rect.height/2;
      const N=26;
      for(let i=0;i<N;i++){
        const sp=document.createElement('div'); sp.className='spark';
        sp.style.left=(cx-2)+'px'; sp.style.top=(cy-2)+'px';
        const ang=(Math.PI*2)*(i/N)+(Math.random()*0.6-0.3);
        const dist=90+Math.random()*130;
        const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist;
        sp.style.setProperty('--dx',dx+'px'); sp.style.setProperty('--dy',dy+'px');
        host.appendChild(sp); setTimeout(()=>sp.remove(),650);
      }
    }
    function screenShake(){ const root=document.getElementById('root'); root.classList.add('shake'); setTimeout(()=>root.classList.remove('shake'),380); }
    function notifyLevelUp(){ const n=document.createElement('div'); n.className='levelup-notification'; n.textContent=`レベルアップ！ Lv.${app.user.level}`; document.body.appendChild(n); setTimeout(()=>n.remove(),3000); renderStats(); }

    // 撃破フィナーレ
    function playFinale(){
      const host=document.querySelector('.boss-section');
      const hpBar=document.querySelector('.hp-bar');
      const img=document.querySelector('.boss-bg img');
      if(img){ img.classList.add('defeated'); }
      // 白フラッシュ
      const flash=document.createElement('div'); flash.className='white-flash'; document.body.appendChild(flash); setTimeout(()=>flash.remove(),500);
      // バースト
      const burst=document.createElement('div'); burst.className='burst'; host.appendChild(burst); setTimeout(()=>burst.remove(),700);
      // HPバー爆ぜる
      hpBar.classList.add('hp-explode'); setTimeout(()=>hpBar.classList.remove('hp-explode'),520);
      // コンフェッティ大噴出
      launchConfetti(120);
      // 花火
      fireworkAt(host, .28, .45);
      fireworkAt(host, .72, .38);
      fireworkAt(host, .5,  .28);
      // 勝利バナー
      const banner=document.createElement('div'); banner.className='victory-banner'; banner.textContent='討 伐 成 功 !!';
      host.appendChild(banner); setTimeout(()=>banner.remove(),2200);
      // 最後にどーんと揺れ
      screenShake();
    }
    function launchConfetti(n){
      const colors=['#ffd166','#06d6a0','#ef476f','#118ab2','#ffe66d','#f78c6b','#a8dadc','#e63946'];
      for(let i=0;i<n;i++){
        const c=document.createElement('div'); c.className='confetti';
        const size=8+Math.random()*10;
        c.style.width=size+'px'; c.style.height=(size*1.4)+'px';
        c.style.left=(Math.random()*100)+'%';
        c.style.background=colors[(Math.random()*colors.length)|0];
        c.style.setProperty('--t',(1.8+Math.random()*1.6)+'s');
        c.style.setProperty('--r',(Math.random()*360-180)+'deg');
        c.style.opacity=0.95;
        document.body.appendChild(c); setTimeout(()=>c.remove(), 3200);
      }
    }
    function fireworkAt(host, px, py){
      const rect=host.getBoundingClientRect();
      const x=rect.left+rect.width*px, y=rect.top+rect.height*py;
      const N=30;
      for(let i=0;i<N;i++){
        const sp=document.createElement('div'); sp.className='spark';
        sp.style.left=x+'px'; sp.style.top=y+'px';
        const ang=(Math.PI*2)*(i/N)+(Math.random()*0.5-0.25);
        const dist=110+Math.random()*150;
        const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist;
        sp.style.setProperty('--dx',dx+'px'); sp.style.setProperty('--dy',dy+'px');
        document.body.appendChild(sp); setTimeout(()=>sp.remove(),750);
      }
    }

    /* ---------- イベント ---------- */
    function bindEvents(){
      dom.gradeBtns.forEach(btn=>btn.addEventListener('click',()=>selectGrade(btn.dataset.grade)));
      dom.username.addEventListener('input',updateStartButton);
      dom.startgamebtn.addEventListener('click',()=>{ app.user.name=dom.username.value.trim(); resetSession(); enterGame(); debounceSave(); });
      dom.startbtn.addEventListener('click',startQuest);
      dom.nextbtn.addEventListener('click',startQuest);
      dom.resetbtn.addEventListener('click',()=>{ resetSession(); dom.resulttext.textContent='新しいボスが現れた！'; dom.startbtn.style.display='inline-block'; dom.nextbtn.style.display='none'; });
      dom.backbtn.addEventListener('click',enterSetup);

      document.addEventListener('keydown',(e)=>{
        if(e.key>='1'&&e.key<='4'){ const idx=Number(e.key)-1; const btn=dom.optionscontainer?.querySelectorAll('.option-btn')[idx]; if(btn && !btn.disabled) btn.click(); }
        const k=e.key.toLowerCase(); if(k==='s'){ if(dom.startbtn.style.display!=='none') dom.startbtn.click(); } if(k==='n'){ if(dom.nextbtn.style.display!=='none') dom.nextbtn.click(); } if(k==='b'){ dom.backbtn.click(); }
      });
    }

    /* ---------- 起動 ---------- */
    function init(){ initializeDOM(); bindEvents(); updateStartButton(); enterSetup(); }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',init); } else { init(); }

  })();
  </script>
</body>
</html>
