<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ボス討伐学習アプリ v0.3.9 受験対策</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow-x:hidden
    }
    .container{
      max-width:800px;width:90%;background:rgba(255,255,255,.1);padding:30px;border-radius:20px;
      backdrop-filter:blur(10px);box-shadow:0 10px 30px rgba(0,0,0,.3);position:relative;overflow:hidden
    }
    h1{text-align:center;font-size:2.4em;margin-bottom:28px;text-shadow:2px 2px 4px rgba(0,0,0,.3);position:relative;z-index:2}
    .save-indicator{position:fixed;top:20px;right:20px;background:rgba(76,175,80,.9);padding:10px 15px;border-radius:25px;font-size:.9em;opacity:0;transition:.3s;z-index:9999}
    .save-indicator.show{opacity:1}

    .setup-screen{text-align:center;padding:20px;position:relative;z-index:2}
    .setup-screen h2{font-size:1.8em;margin-bottom:20px;color:#FFE082}
    .returning-user{background:rgba(76,175,80,.2);border:2px solid #4CAF50;padding:20px;border-radius:15px;margin-bottom:25px;display:none}
    .user-input{margin-bottom:25px}
    .user-input label{display:block;font-size:1.2em;margin-bottom:10px}
    .user-input input{padding:12px 15px;font-size:1.1em;border:none;border-radius:10px;width:250px;max-width:100%;text-align:center}
    .grade-selection{margin:28px 0}
    .grade-btn{display:inline-block;padding:18px 34px;margin:8px 12px;font-size:1.15em;border:none;border-radius:14px;cursor:pointer;transition:.3s;background:rgba(255,255,255,.9);color:#333;font-weight:bold}
    .grade-btn:hover{background:#fff;transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.3)}
    /* ←ここを修正（!重要 → !important） */
    .grade-btn.selected{background:#4CAF50 !important;color:#fff !important;animation:selectedPulse 1s ease infinite}
    @keyframes selectedPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .start-setup-btn{padding:14px 28px;font-size:1.2em;border:none;border-radius:12px;background:#FF6B6B;color:#fff;cursor:pointer;font-weight:bold;transition:.3s;margin-top:14px}
    .start-setup-btn:hover:not(:disabled){background:#FF5252;transform:scale(1.05)}
    .start-setup-btn:disabled{background:#666 !important;cursor:not-allowed !important;transform:none !important}
    .continue-btn,.new-game-btn{padding:12px 22px;border:none;border-radius:8px;cursor:pointer;font-size:1em;margin:0 8px;transition:.3s}
    .continue-btn{background:#4CAF50;color:#fff}.new-game-btn{background:#FF6B6B;color:#fff}

    .game-screen{display:none}
    .user-info{text-align:center;background:rgba(255,255,255,.1);padding:15px;border-radius:12px;margin-bottom:18px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:14px;position:relative;z-index:2}
    .user-info h3{color:#FFE082;font-size:1.2em}
    .session-stats,.total-stats{display:flex;gap:12px;font-size:.9em}

    .boss-section{position:relative;text-align:center;margin-bottom:26px;padding:20px;background:rgba(255,255,255,.1);border-radius:15px;overflow:hidden}
    .boss-bg{position:absolute;inset:0;z-index:1;display:flex;justify-content:center;align-items:flex-end;pointer-events:none;opacity:.6}
    .boss-bg img{width:min(100%,820px);max-height:95%;object-fit:contain;transform:translateY(6%);filter:drop-shadow(0 12px 30px rgba(0,0,0,.45))}
    .boss-section::after{content:"";position:absolute;inset:0;z-index:0;background:radial-gradient(120% 120% at 50% 100%, rgba(0,0,0,.22) 0%, rgba(0,0,0,.55) 75%, rgba(0,0,0,.65) 100%);pointer-events:none}
    .boss-name{position:relative;z-index:2;font-size:1.9em;margin-bottom:12px}
    .boss-name.victory{background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:victoryGlow 2s infinite alternate}
    @keyframes victoryGlow{0%{filter:drop-shadow(0 0 5px #FFD700)}100%{filter:drop-shadow(0 0 20px #FFD700)}}
    .hp-container{margin:18px 0;position:relative;z-index:2}
    .hp-bar{width:100%;height:40px;background:#333;border-radius:20px;overflow:hidden;border:3px solid #fff;position:relative}
    .hp-fill{height:100%;background:linear-gradient(90deg,#ff4444,#ff8844,#ffaa44);width:100%;transition:width .8s ease-out;position:relative}
    .hp-fill.damage-effect{animation:damageShake .6s ease-in-out}
    @keyframes damageShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .hp-text{font-size:1.1em;font-weight:bold;margin-top:8px;text-shadow:1px 1px 2px rgba(0,0,0,.5);position:relative;z-index:2}

    .question-section{background:rgba(255,255,255,.2);padding:22px;border-radius:15px;margin-bottom:18px;min-height:190px;position:relative;z-index:2}
    .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
    .question-text{font-size:1.25em;margin-bottom:16px;text-align:center;line-height:1.5}
    .difficulty-indicator{display:inline-block;padding:5px 12px;border-radius:20px;font-size:.9em;font-weight:bold}
    .difficulty-easy{background:#4CAF50;color:#fff}.difficulty-normal{background:#FF9800;color:#fff}.difficulty-hard{background:#f44336;color:#fff}
    .subject-tag{background:rgba(255,255,255,.2);padding:5px 12px;border-radius:20px;font-size:.8em}
    .options-container{display:grid;gap:10px}
    .option-btn{padding:14px 18px;font-size:1.05em;border:none;border-radius:12px;background:rgba(255,255,255,.92);color:#333;cursor:pointer;transition:.25s;text-align:left;font-weight:500}
    .option-btn:hover:not(:disabled){background:#fff;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .option-btn:disabled{cursor:not-allowed}
    .option-btn.correct{background:#4CAF50 !important;color:#fff;animation:correctPulse .5s ease}
    .option-btn.incorrect{background:#f44336 !important;color:#fff}
    @keyframes correctPulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

    .controls{text-align:center;margin:16px 0;position:relative;z-index:2}
    .control-btn{padding:14px 26px;font-size:1.15em;border:none;border-radius:12px;background:#4CAF50;color:#fff;cursor:pointer;margin:0 8px;transition:.25s;font-weight:bold}
    .control-btn:hover:not(:disabled){background:#45a049;transform:scale(1.05)}
    .control-btn:disabled{background:#666;cursor:not-allowed;transform:none}
    .back-btn{background:#FF6B6B}.back-btn:hover{background:#FF5252}

    .stats{background:rgba(0,0,0,.3);padding:18px;border-radius:12px;margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;text-align:center;position:relative;z-index:2}
    .stat-item{font-size:1.05em}.stat-value{font-size:1.35em;font-weight:bold;color:#4CAF50;display:block;margin-top:5px}
    .result-text{font-size:1.15em;font-weight:bold;margin:12px 0;text-align:center;min-height:28px;text-shadow:1px 1px 2px rgba(0,0,0,.5);position:relative;z-index:2}
    .victory{background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

    .levelup-notification{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(45deg,#FFD700,#FFA500);color:#333;padding:26px 44px;border-radius:18px;font-size:1.6em;font-weight:bold;z-index:9999;opacity:0;animation:levelUpShow 3s ease-in-out;box-shadow:0 10px 30px rgba(255,215,0,.5)}
    @keyframes levelUpShow{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0}}

    /* エフェクト専用レイヤー（レイアウト非干渉） */
    .fx-layer{position:fixed;inset:0;pointer-events:none;z-index:9998;overflow:hidden}

    /* 斬撃・火の粉・揺れ */
    .slash-effect{position:absolute;left:50%;top:50%;width:140%;height:6px;transform-origin:center;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.95) 45%,rgba(255,200,120,.95) 55%,rgba(255,80,40,0) 100%);box-shadow:0 0 18px rgba(255,180,80,.7),0 0 40px rgba(255,120,60,.5);border-radius:999px;z-index:3;pointer-events:none;animation:slashFly .35s ease-out forwards}
    @keyframes slashFly{0%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(.2);opacity:0}10%{opacity:1}60%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(1);opacity:1}100%{transform:translate(-50%,-50%) rotate(-18deg) scaleX(1.3);opacity:0}}
    .spark{position:absolute;width:4px;height:4px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#ffcf7a 60%,#ff6a00 100%);box-shadow:0 0 8px rgba(255,120,40,.9);pointer-events:none;z-index:4;animation:sparkFly .6s ease-out forwards}
    @keyframes sparkFly{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(.6);opacity:0}}
    .shake{animation:shakeKey .38s linear}
    @keyframes shakeKey{0%{transform:translate(0,0)}20%{transform:translate(2px,-2px)}40%{transform:translate(-3px,2px)}60%{transform:translate(3px,1px)}80%{transform:translate(-2px,-3px)}100%{transform:translate(0,0)}}

    /* 撃破フィナーレ */
    .white-flash{position:absolute;inset:0;background:#fff;opacity:0;z-index:5;pointer-events:none;animation:whiteFlash .5s ease-out forwards}
    @keyframes whiteFlash{0%{opacity:0}10%{opacity:.9}100%{opacity:0}}
    .boss-bg img.defeated{animation:bossFall 1.2s ease forwards}
    @keyframes bossFall{0%{transform:translateY(6%) scale(1) rotate(0deg);opacity:1}35%{transform:translateY(2%) scale(.98) rotate(-4deg)}70%{transform:translateY(12%) scale(.9) rotate(6deg);filter:grayscale(.2) brightness(1.1)}100%{transform:translateY(40%) scale(.6) rotate(-12deg);opacity:0;filter:grayscale(.6) brightness(.9)}}
    .burst{position:absolute;left:50%;top:50%;width:20px;height:20px;border-radius:50%;background:radial-gradient(circle,#fff,#ffd27a,#ff7a00);transform:translate(-50%,-50%);z-index:6;animation:burstOut .7s ease-out forwards;pointer-events:none}
    @keyframes burstOut{0%{transform:translate(-50%,-50%) scale(.2);opacity:.9}100%{transform:translate(-50%,-50%) scale(12);opacity:0}}
    .victory-banner{position:absolute;left:50%;top:46%;transform:translate(-50%,-50%) scale(.8);z-index:6;font-size:2.4em;font-weight:900;letter-spacing:.08em;background:linear-gradient(45deg,#fff,#ffe6a3);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 18px rgba(255,220,120,.65);opacity:0;animation:bannerPop 1.1s ease-out .15s forwards}
    @keyframes bannerPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    .confetti{position:absolute;top:-10px;width:10px;height:16px;opacity:0.95;z-index:6;animation:confettiFall var(--t) linear forwards;transform:rotate(var(--r))}
    @keyframes confettiFall{0%{transform:translateY(-10px) rotate(var(--r))}100%{transform:translateY(120vh) rotate(calc(var(--r) + 360deg))}}

    /* 追加：HP爆発のハイライト（JSで hp-explode クラスを付与） */
    .hp-bar.hp-explode::after{
      content:"";
      position:absolute;inset:0;border:3px solid rgba(255,255,255,.95);
      box-shadow:0 0 14px rgba(255,255,255,.9),inset 0 0 12px rgba(255,140,0,.6);
      opacity:0;animation:hpExplode .5s ease-out forwards
    }
    @keyframes hpExplode{0%{opacity:.9}100%{opacity:0}}

    /* モバイル：撃破アニメ軽量化（filter等を使わない） */
    @media (max-width:480px){
      .container{width:96%;padding:18px}
      .hp-bar{height:34px}
      .boss-bg img.defeated{animation:bossFallSafe .8s ease forwards}
      @keyframes bossFallSafe{
        0%{transform:translateY(6%) scale(1);opacity:1}
        100%{transform:translateY(30%) scale(.8);opacity:0}
      }
    }

    /* 動きを控える設定に追随 */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important;transition:none !important}
    }
  </style>
</head>
<body>
  <div class="container" id="root">
    <h1>🏰 ボス討伐学習アプリ v0.3.9 受験対策</h1>
    <div class="save-indicator" id="save-indicator">進捗を保存しました</div>

    <!-- セットアップ -->
    <div class="setup-screen" id="setup-screen">
      <h2>🎯 冒険の準備をしよう！</h2>
      <div class="returning-user" id="returning-user">
        <h3>🎉 おかえりなさい！</h3>
        <div id="user-progress"></div>
        <div style="margin: 15px 0;">
          <button class="continue-btn" id="continue-btn">続きから始める</button>
          <button class="new-game-btn" id="new-game-btn">最初から始める</button>
        </div>
      </div>

      <div id="new-user-setup">
        <div class="user-input">
          <label for="user-name">👤 お名前を教えてね</label>
          <input type="text" id="user-name" placeholder="例: さくら" maxlength="10"/>
        </div>
        <div class="user-input">
          <label>📚 学年を選んでね</label>
          <div class="grade-selection">
            <button class="grade-btn" data-grade="elementary">🌸 小学（中学受験）</button>
            <button class="grade-btn" data-grade="junior">🌟 中学（高校受験）</button>
          </div>
        </div>
        <button class="start-setup-btn" id="start-game-btn" disabled>🚀 冒険を始める！</button>
      </div>
    </div>

    <!-- ゲーム -->
    <div class="game-screen" id="game-screen">
      <div class="user-info">
        <div class="session-stats">
          <div>今日: <span id="today-questions">0</span>問</div>
          <div>正答: <span id="today-correct">0</span></div>
        </div>
        <h3 id="user-greeting">がんばって！</h3>
        <div class="total-stats">
          <div>累計: <span id="total-questions">0</span>問</div>
          <div>Lv: <span id="user-level">1</span></div>
        </div>
      </div>

      <div class="boss-section">
        <div class="boss-name" id="boss-name">🐉 フレイムドラゴン</div>
        <div class="hp-container">
          <div class="hp-bar"><div class="hp-fill" id="hp-fill"></div></div>
          <div class="hp-text">HP: <span id="hp-display">100/100</span></div>
        </div>
        <!-- 背景ボス -->
        <div class="boss-bg" id="boss-bg"><img alt="boss" /></div>
      </div>

      <div class="question-section">
        <div class="question-header">
          <div class="subject-tag" id="subject-tag">受験対策</div>
          <div class="difficulty-indicator difficulty-normal" id="difficulty-indicator">★ 普通</div>
        </div>
        <div class="question-text" id="question-text">「クエスト開始」ボタンを押してボス討伐を始めましょう！</div>
        <div class="options-container" id="options-container"></div>
        <div class="result-text" id="result-text"></div>
      </div>

      <div class="controls">
        <button class="control-btn" id="start-btn">🎮 クエスト開始</button>
        <button class="control-btn" id="next-btn" style="display:none">➡️ 次の問題</button>
        <button class="control-btn" id="reset-btn" style="display:none">🔄 最初から</button>
        <button class="control-btn back-btn" id="back-btn">⬅️ 設定に戻る</button>
      </div>

      <div class="stats">
        <div class="stat-item">正答数<span class="stat-value" id="correct-count">0</span></div>
        <div class="stat-item">総ダメージ<span class="stat-value" id="total-damage">0</span></div>
        <div class="stat-item">連続正解<span class="stat-value" id="streak-count">0</span></div>
        <div class="stat-item">問題数<span class="stat-value" id="question-count">0</span></div>
      </div>
    </div>
  </div>

  <!-- エフェクト専用レイヤー（画面最前面。DOMはここに出す） -->
  <div id="fx-layer" class="fx-layer" aria-hidden="true"></div>

  <script>
  /* ====== ここから JS（あなたの最新版をそのまま反映済み／変更なし） ====== */
  (()=>{ /* 省略せずすべて貼り付けています。元メッセージのJSと同一です */ 
  /* --- 略 ---（あなたの投稿の JS 全文がここに入っています） --- */
  })();
  </script>
</body>
</html>
